# å®‰è£…æŒ‡å—

å°† Entity Engine æ·»åŠ åˆ°æ‚¨çš„ Next.js é¡¹ç›®ä¸­ï¼Œå¼€å§‹æ„å»ºå¼ºå¤§çš„æ•°æ®é©±åŠ¨åº”ç”¨ã€‚

## æ¦‚è¿°

Entity Engine æ˜¯ä¸€ä¸ª TypeScript ä¼˜å…ˆçš„å¼€å‘æ¡†æ¶ï¼Œä¸“ä¸ºå¿«é€Ÿæ„å»ºä¼ä¸šçº§æ•°æ®ç®¡ç†åº”ç”¨è€Œè®¾è®¡ã€‚å®ƒè‡ªåŠ¨ç”Ÿæˆ UI ç»„ä»¶ã€å¤„ç†æ•°æ®éªŒè¯ï¼Œå¹¶æä¾›ä¸°å¯Œçš„è¡¨å•å’Œè¡¨æ ¼åŠŸèƒ½ã€‚

## å‰ææ¡ä»¶

å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„å¼€å‘ç¯å¢ƒæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š

- **Node.js** 18.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **PostgreSQL** 12+ æ•°æ®åº“
- **Next.js** 14+ é¡¹ç›®ï¼ˆæ”¯æŒ App Router å’Œ Pages Routerï¼‰

> **ä¿¡æ¯**  
> Entity Engine ä¸“ä¸º PostgreSQL ä¼˜åŒ–ï¼Œåˆ©ç”¨å…¶ JSON æŸ¥è¯¢å’Œé«˜çº§ç´¢å¼•ç‰¹æ€§æä¾›æœ€ä½³æ€§èƒ½ã€‚

## å®‰è£…æ–¹å¼

Entity Engine å®‰è£…æ–¹å¼

### ä½¿ç”¨ CLI å¿«é€Ÿåˆå§‹åŒ–

Entity Engine æä¾›äº†å¼ºå¤§çš„ CLI å·¥å…· `setup-ee`ï¼Œå¯ä»¥å¿«é€Ÿåˆå§‹åŒ–ä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®ï¼š

```bash
# åˆå§‹åŒ– Entity Engine é¡¹ç›®çš„æ•°æ®å±‚
npx setup-ee 

CLI å·¥å…·ä¼šè‡ªåŠ¨ï¼š
- é…ç½®æ•°æ®å±‚ï¼ˆç”Ÿæˆprismaå®¢æˆ·ç«¯å’Œæ•°æ®åº“ç»“æ„ï¼‰

### 1. å®‰è£…æ ¸å¿ƒåŒ…

åœ¨æ‚¨çš„ Next.js é¡¹ç›®ä¸­å®‰è£… Entity Engineï¼š

```bash
npm install @scenemesh/entity-engine
```

### 2. å®‰è£… UI ä¾èµ–

Entity Engine åŸºäº Mantine æ„å»ºï¼Œéœ€è¦å®‰è£…ä»¥ä¸‹ UI ç»„ä»¶ï¼š

```bash
# Mantine ç»„ä»¶åº“ (å¿…éœ€ç‰ˆæœ¬)
npm install @mantine/core@8.2.5 @mantine/hooks@8.2.5
npm install @mantine/modals@8.2.5 @mantine/notifications@8.2.5  
npm install mantine-datatable@8.2.0

# è¡¨å•å’Œæ—¥æœŸå¤„ç†
npm install react-hook-form dayjs
```

### æ‰‹åŠ¨æ•°æ®åº“é…ç½®

#### 1. å‡†å¤‡ PostgreSQL æ•°æ®åº“

ç¡®ä¿æ‚¨å·²å®‰è£…å¹¶å¯åŠ¨ PostgreSQLï¼š

```bash
# éªŒè¯ PostgreSQL è¿è¡ŒçŠ¶æ€
pg_isready -h localhost -p 5432
```

å¦‚æœçœ‹åˆ° `accepting connections`ï¼Œè¯´æ˜æ•°æ®åº“æ­£å¸¸è¿è¡Œã€‚

#### 2. åˆ›å»ºåº”ç”¨æ•°æ®åº“

è¿æ¥åˆ° PostgreSQL å¹¶åˆ›å»ºä¸“ç”¨æ•°æ®åº“ï¼š

```sql
-- è¿æ¥åˆ° PostgreSQL
psql -U postgres

-- åˆ›å»ºæ•°æ®åº“å’Œä¸“ç”¨ç”¨æˆ·
CREATE DATABASE my_entity_app;
CREATE USER entity_user WITH PASSWORD 'secure_password';
GRANT ALL PRIVILEGES ON DATABASE my_entity_app TO entity_user;

-- é€€å‡º psql
\q
```

#### 3. é…ç½®ç¯å¢ƒå˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env.local` æ–‡ä»¶ï¼š

```env filename=".env.local"
# Entity Engine ä¸“ç”¨æ•°æ®åº“è¿æ¥
EE_DATABASE_URL="postgresql://entity_user:secure_password@localhost:5432/my_entity_app?schema=public"

# API ç«¯ç‚¹é…ç½®
NEXT_PUBLIC_API_BASE_URL=""
NEXT_PUBLIC_API_ENDPOINT="/api/ee"
```

> **é‡è¦**  
> Entity Engine ä½¿ç”¨ä¸“ç”¨çš„ `EE_DATABASE_URL` ç¯å¢ƒå˜é‡ï¼Œè¿™ä¸æ ‡å‡†çš„ `DATABASE_URL` ä¸åŒã€‚è¯·ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„å˜é‡åã€‚

## Prisma æ•°æ®åº“é…ç½®

### 1. åˆå§‹åŒ– Prisma

å¦‚æœæ‚¨çš„é¡¹ç›®è¿˜æ²¡æœ‰ Prismaï¼Œè¯·å…ˆåˆå§‹åŒ–ï¼š

```bash
npx prisma init
```

### 2. é…ç½®æ•°æ®åº“ Schema

Entity Engine éœ€è¦ç‰¹å®šçš„æ•°æ®åº“ç»“æ„ã€‚å°†ä»¥ä¸‹å†…å®¹å†™å…¥ `prisma/schema.prisma`ï¼š

```prisma filename="prisma/schema.prisma"
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("EE_DATABASE_URL")
}

// Entity Engine æ ¸å¿ƒæ•°æ®è¡¨
model EntityObject {
  id        String   @id @db.VarChar(32)
  modelName String   @db.VarChar(255)
  values    Json     @default("{}")
  isDeleted Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
  @@index([modelName])
  @@index([modelName, isDeleted])
  @@index([modelName, createdAt])

  // å…³è”å…³ç³»
  EntityObjectReference EntityObjectReference[] @relation(name: "to")
}

// å®ä½“é—´å…³è”å…³ç³»è¡¨
model EntityObjectReference {
  id            Int      @id @default(autoincrement())
  fromFieldName String   @db.VarChar(255)
  fromModelName String   @db.VarChar(255)
  fromObjectId  String   @db.VarChar(32)
  toModelName   String   @db.VarChar(255)
  toObjectId    String   @db.VarChar(32)
  toObject      EntityObject @relation(fields: [toObjectId], references: [id], name: "to")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // å…³è”æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•
  @@index([fromModelName, fromObjectId])
  @@index([toModelName, toObjectId])
  @@index([fromModelName, fromFieldName])
}
```

### 3. ç”Ÿæˆæ•°æ®åº“è¡¨

è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„ï¼š

```bash
# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯ä»£ç 
npx prisma generate

# å°† Schema åŒæ­¥åˆ°æ•°æ®åº“
npx prisma db push
```

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„è¾“å‡ºï¼š
```
ğŸš€  Your database is now in sync with your Prisma schema.
âœ” Generated Prisma Client (v5.x.x)
```

## æ ·å¼é…ç½®

Entity Engine éœ€è¦å¯¼å…¥å¿…è¦çš„ CSS æ ·å¼æ–‡ä»¶æ‰èƒ½æ­£å¸¸æ˜¾ç¤º UI ç»„ä»¶ã€‚

### å¯¼å…¥æ ·å¼æ–‡ä»¶

æ ¹æ®æ‚¨ä½¿ç”¨çš„ Next.js è·¯ç”±æ¨¡å¼ï¼Œé€‰æ‹©å¯¹åº”çš„é…ç½®æ–¹å¼ï¼š

#### App Router

åœ¨ `app/layout.tsx` ä¸­å¯¼å…¥æ‰€æœ‰å¿…éœ€çš„æ ·å¼ï¼š

```typescript filename="app/layout.tsx"
import '@scenemesh/entity-engine/main.css';
import '@mantine/core/styles.css';
import '@mantine/notifications/styles.css';
import '@mantine/modals/styles.css';
import 'mantine-datatable/styles.css';

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="zh">
      <body>{children}</body>
    </html>
  );
}
```

#### Pages Router

åœ¨ `pages/_app.tsx` ä¸­å¯¼å…¥æ‰€æœ‰å¿…éœ€çš„æ ·å¼ï¼š

```typescript filename="pages/_app.tsx"
import '@scenemesh/entity-engine/main.css';
import '@mantine/core/styles.css';
import '@mantine/notifications/styles.css';
import '@mantine/modals/styles.css';
import 'mantine-datatable/styles.css';
import type { AppProps } from 'next/app';

export default function App({ Component, pageProps }: AppProps) {
  return <Component {...pageProps} />;
}
```

> **ä¿¡æ¯**  
> è¿™äº›æ ·å¼æ–‡ä»¶çš„å¯¼å…¥é¡ºåºå¾ˆé‡è¦ï¼Œè¯·æŒ‰ç…§ç¤ºä¾‹ä¸­çš„é¡ºåºå¯¼å…¥ä»¥é¿å…æ ·å¼å†²çªã€‚

### åˆ›å»ºéªŒè¯è„šæœ¬

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `scripts/verify-installation.ts`ï¼š

```typescript filename="scripts/verify-installation.ts"
import { EnginePrimitiveInitializer } from '@scenemesh/entity-engine/server';
import { PrismaClient } from '@prisma/client';

async function verifyInstallation() {
  console.log('ğŸ” éªŒè¯ Entity Engine å®‰è£…...\n');

  try {
    // 1. æµ‹è¯•æ•°æ®åº“è¿æ¥
    console.log('1. æ£€æŸ¥æ•°æ®åº“è¿æ¥...');
    const prisma = new PrismaClient();
    await prisma.$connect();
    console.log('   âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ');

    // 2. æ£€æŸ¥æ ¸å¿ƒè¡¨æ˜¯å¦å­˜åœ¨
    console.log('2. æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„...');
    await prisma.entityObject.findMany({ take: 1 });
    await prisma.entityObjectReference.findMany({ take: 1 });
    console.log('   âœ… æ•°æ®åº“è¡¨ç»“æ„æ­£ç¡®');

    // 3. æµ‹è¯• Entity Engine åˆå§‹åŒ–
    console.log('3. æµ‹è¯• Entity Engine åˆå§‹åŒ–...');
    const initializer = new EnginePrimitiveInitializer({
      models: [],
      views: [],
    });
    console.log('   âœ… Entity Engine åˆå§‹åŒ–æˆåŠŸ');

    await prisma.$disconnect();
    console.log('\nğŸ‰ å®‰è£…éªŒè¯å®Œæˆï¼æ‚¨å¯ä»¥å¼€å§‹ä½¿ç”¨ Entity Engine äº†ã€‚');

  } catch (error) {
    console.error('\nâŒ éªŒè¯å¤±è´¥:');
    if (error instanceof Error) {
      console.error(`   é”™è¯¯: ${error.message}`);
    } else {
      console.error(`   æœªçŸ¥é”™è¯¯: ${error}`);
    }
    console.log('\nğŸ’¡ è¯·æ£€æŸ¥ï¼š');
    console.log('   â€¢ PostgreSQL æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ');
    console.log('   â€¢ EE_DATABASE_URL ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®');
    console.log('   â€¢ æ˜¯å¦å·²è¿è¡Œ npx prisma db push');
  }
}

verifyInstallation();
```

### è¿è¡ŒéªŒè¯

```bash
# å¦‚æœè¿˜æ²¡æœ‰å®‰è£… tsxï¼Œå…ˆå®‰è£…å®ƒ
npm install -D tsx

# è¿è¡ŒéªŒè¯è„šæœ¬
npx tsx scripts/verify-installation.ts
```

å¦‚æœå®‰è£…æ­£ç¡®ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

```
ğŸ” éªŒè¯ Entity Engine å®‰è£…...

1. æ£€æŸ¥æ•°æ®åº“è¿æ¥...
   âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ
2. æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„...
   âœ… æ•°æ®åº“è¡¨ç»“æ„æ­£ç¡®
3. æµ‹è¯• Entity Engine åˆå§‹åŒ–...
   âœ… Entity Engine åˆå§‹åŒ–æˆåŠŸ

ğŸ‰ å®‰è£…éªŒè¯å®Œæˆï¼æ‚¨å¯ä»¥å¼€å§‹ä½¿ç”¨ Entity Engine äº†ã€‚
```

## å¸¸è§é—®é¢˜

å®‰è£…è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼š

### æ•°æ®åº“è¿æ¥é—®é¢˜

**é”™è¯¯**: `Can't reach database server at localhost:5432`

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®è®¤ PostgreSQL æ­£åœ¨è¿è¡Œï¼š`pg_isready -h localhost -p 5432`
2. æ£€æŸ¥ `EE_DATABASE_URL` è¿æ¥å­—ç¬¦ä¸²æ ¼å¼
3. éªŒè¯æ•°æ®åº“ç”¨æˆ·æƒé™æ˜¯å¦æ­£ç¡®

### ä¾èµ–å®‰è£…é—®é¢˜

**é”™è¯¯**: `Cannot find module '@scenemesh/entity-engine'`

**è§£å†³æ–¹æ¡ˆ**:
1. æ¸…ç†å¹¶é‡æ–°å®‰è£…ï¼š`rm -rf node_modules package-lock.json && npm install`
2. ç¡®è®¤ Node.js ç‰ˆæœ¬ >= 18.0.0
3. æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ npm æºé…ç½®

### æ ·å¼æ˜¾ç¤ºé—®é¢˜

**é”™è¯¯**: UI ç»„ä»¶æ ·å¼ç¼ºå¤±æˆ–é”™ä¹±

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®è®¤å·²æŒ‰æ­£ç¡®é¡ºåºå¯¼å…¥æ‰€æœ‰ CSS æ–‡ä»¶
2. æ£€æŸ¥ Mantine ç‰ˆæœ¬æ˜¯å¦ä¸ºæŒ‡å®šç‰ˆæœ¬ï¼ˆ8.2.5ï¼‰
3. æ¸…ç† Next.js ç¼“å­˜ï¼š`rm -rf .next && npm run dev`

### CLI å·¥å…·é—®é¢˜

**é”™è¯¯**: `Command 'setup-ee' not found`

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®è®¤ä½¿ç”¨ `npx setup-ee` è€Œä¸æ˜¯ç›´æ¥è¿è¡Œ `setup-ee`
2. æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œç¡®ä¿èƒ½å¤Ÿä¸‹è½½ npm åŒ…
3. å°è¯•æ¸…ç† npx ç¼“å­˜ï¼š`npx clear-npx-cache`

> **æç¤º**  
> å¦‚æœé‡åˆ°å…¶ä»–é—®é¢˜ï¼Œå¯ä»¥è¿è¡ŒéªŒè¯è„šæœ¬è·å–è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œæˆ–æŸ¥çœ‹ [å¸¸è§é—®é¢˜è§£ç­”](./faq-beginner) è·å–æ›´å¤šå¸®åŠ©ã€‚

## ä¸‹ä¸€æ­¥

å®‰è£…å®Œæˆåï¼Œæ‚¨å¯ä»¥ï¼š

1. **[å¿«é€Ÿå¼€å§‹](./quick-start-nextjs)** - 15 åˆ†é’Ÿåˆ›å»ºç¬¬ä¸€ä¸ªäº§å“ç®¡ç†åº”ç”¨
2. **[äº†è§£é¡¹ç›®ç»“æ„](./project-structure)** - å­¦ä¹ å¦‚ä½•ç»„ç»‡ä»£ç å’Œæœ€ä½³å®è·µ  
3. **[æ„å»ºå®Œæ•´åº”ç”¨](./first-model-and-view)** - æ·±å…¥å­¦ä¹ æ¨¡å‹å®šä¹‰å’Œè§†å›¾é…ç½®

ğŸ¯ **æ¨èè·¯å¾„**: å…ˆå®Œæˆå¿«é€Ÿå¼€å§‹æ•™ç¨‹ï¼Œä½“éªŒ Entity Engine çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç„¶åæ·±å…¥å­¦ä¹ é¡¹ç›®ç»“æ„å’Œé«˜çº§ç‰¹æ€§ã€‚