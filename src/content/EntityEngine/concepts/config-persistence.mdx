# é…ç½®æŒä¹…åŒ–

è®©æ‚¨çš„æ¨¡åž‹å’Œè§†å›¾é…ç½®æ°¸ä¹…ä¿å­˜ï¼Œæ”¯æŒç‰ˆæœ¬ç®¡ç†å’ŒçŽ¯å¢ƒåŒæ­¥ã€‚æ³¨å†Œæ¨¡åž‹æˆ–è§†å›¾æ—¶ï¼ŒEntity Engine ä¼šè‡ªåŠ¨å°†é…ç½®å­˜å‚¨åˆ°æ•°æ®åº“çš„ `__config__` è¡¨ä¸­ã€‚

## è‡ªåŠ¨ä¿å­˜é…ç½®

æ³¨å†Œæ¨¡åž‹æ—¶é…ç½®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ã€‚æ— éœ€æ‰‹åŠ¨æ“ä½œï¼Œå¼•æ“Žä¼šå¤„ç†æ‰€æœ‰æŒä¹…åŒ–ç»†èŠ‚ï¼š

```typescript
import { getEntityEngine } from './lib/entity-engine';

const engine = await getEntityEngine();

// æ³¨å†Œæ¨¡åž‹ - é…ç½®è‡ªåŠ¨ä¿å­˜
await engine.metaRegistry.updateOrRegister({
  name: 'User',
  title: 'ç”¨æˆ·ç®¡ç†',
  fields: [
    { name: 'id', title: 'ID', type: 'string', isRequired: true },
    { name: 'name', title: 'å§“å', type: 'string', isRequired: true },
    { name: 'email', title: 'é‚®ç®±', type: 'string', isRequired: true }
  ]
});

// é…ç½®å·²ä¿å­˜åˆ°æ•°æ®åº“ __config__ è¡¨
// é”®å: "model:User"
// åŒ…å«å®Œæ•´çš„æ¨¡åž‹å®šä¹‰å’Œç‰ˆæœ¬ä¿¡æ¯
```

æ³¨å†Œè§†å›¾æ—¶åŒæ ·è‡ªåŠ¨ä¿å­˜ï¼š

```typescript
// æ³¨å†Œè§†å›¾ - é…ç½®è‡ªåŠ¨ä¿å­˜
await engine.metaRegistry.updateOrRegisterView({
  modelName: 'User',
  name: 'UserFormView',
  title: 'ç”¨æˆ·è¡¨å•',
  type: 'FormView',
  config: {
    fields: ['name', 'email'],
    submitAction: 'create'
  }
});

// é…ç½®å·²ä¿å­˜åˆ°æ•°æ®åº“
// é”®å: "view:User:UserFormView"
```

## é…ç½®é”®å‘½åè§„åˆ™

å¼•æ“Žä½¿ç”¨æ ‡å‡†åŒ–çš„é”®åæ¥ç»„ç»‡ä¸åŒç±»åž‹çš„é…ç½®ï¼š

```typescript
// é…ç½®é”®çš„å‘½åçº¦å®š
model:User          // ç”¨æˆ·æ¨¡åž‹é…ç½®
view:User:FormView  // ç”¨æˆ·è¡¨å•è§†å›¾é…ç½®
fieldtype:RichText  // å¯Œæ–‡æœ¬å­—æ®µç±»åž‹é…ç½®
module:BlogModule   // åšå®¢æ¨¡å—é…ç½®
```

è¿™ç§çº¦å®šè®©æ‚¨å¯ä»¥å¿«é€Ÿå®šä½ç‰¹å®šçš„é…ç½®é¡¹ã€‚

## æŸ¥çœ‹å·²ä¿å­˜çš„é…ç½®

é…ç½®ä¿å­˜åŽï¼Œæ‚¨å¯ä»¥é€šè¿‡æ•°æ®æºç›´æŽ¥æŸ¥è¯¢ï¼š

```typescript
// æŸ¥çœ‹æ‰€æœ‰æ¨¡åž‹é…ç½®
const modelConfigs = await engine.datasourceFactory
  .create('__config__')
  .listObjects({
    modelName: '__config__',
    filter: {
      name: { startsWith: 'model:' }
    }
  });

console.log('å·²æ³¨å†Œçš„æ¨¡åž‹ï¼š', modelConfigs.items.length);

// æŸ¥çœ‹ç‰¹å®šæ¨¡åž‹çš„é…ç½®
const userConfig = await engine.datasourceFactory
  .create('__config__')
  .getObject({
    modelName: '__config__',
    filter: {
      name: 'model:User'
    }
  });

if (userConfig) {
  const modelDef = JSON.parse(userConfig.content);
  console.log('ç”¨æˆ·æ¨¡åž‹å­—æ®µï¼š', modelDef.fields.length);
}
```

## ç‰ˆæœ¬ç®¡ç†

æ¯æ¬¡æ›´æ–°æ¨¡åž‹æˆ–è§†å›¾æ—¶ï¼Œå¼•æ“Žä¼šè‡ªåŠ¨åˆ›å»ºæ–°ç‰ˆæœ¬ï¼š

```typescript
// é¦–æ¬¡æ³¨å†Œ - è‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬ 1
await engine.metaRegistry.updateOrRegister({
  name: 'Product',
  title: 'äº§å“',
  fields: [
    { name: 'name', title: 'äº§å“å', type: 'string' }
  ]
});

// æ›´æ–°æ¨¡åž‹ - è‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬ 2
await engine.metaRegistry.updateOrRegister({
  name: 'Product',
  title: 'äº§å“ç®¡ç†',  // ä¿®æ”¹æ ‡é¢˜
  fields: [
    { name: 'name', title: 'äº§å“å', type: 'string' },
    { name: 'price', title: 'ä»·æ ¼', type: 'number' } // æ–°å¢žå­—æ®µ
  ]
});

// ç‰ˆæœ¬ä¿¡æ¯è‡ªåŠ¨ä¿å­˜åœ¨ __config__ è¡¨çš„ version å­—æ®µ
```

æŸ¥çœ‹ç‰ˆæœ¬åŽ†å²ï¼š

```typescript
// æŸ¥è¯¢ç‰¹å®šé…ç½®çš„æ‰€æœ‰ç‰ˆæœ¬
const versions = await engine.datasourceFactory
  .create('__config__')
  .listObjects({
    modelName: '__config__',
    filter: {
      name: 'model:Product'
    },
    orderBy: [{ field: 'version', direction: 'desc' }]
  });

console.log('Product æ¨¡åž‹æœ‰', versions.items.length, 'ä¸ªç‰ˆæœ¬');

// èŽ·å–æœ€æ–°ç‰ˆæœ¬
const latestVersion = versions.items[0];
console.log('æœ€æ–°ç‰ˆæœ¬:', latestVersion.version);
```

## é…ç½®åŒæ­¥

åœ¨ä¸åŒçŽ¯å¢ƒé—´åŒæ­¥é…ç½®ï¼ˆå¦‚å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰ï¼š

```typescript
// å¯¼å‡ºç”Ÿäº§çŽ¯å¢ƒçš„é…ç½®
const prodConfigs = await engine.datasourceFactory
  .create('__config__')
  .listObjects({
    modelName: '__config__',
    filter: {
      name: { startsWith: 'model:' }
    }
  });

// ä¿å­˜åˆ° JSON æ–‡ä»¶
const configData = prodConfigs.items.map(item => ({
  name: item.name,
  version: item.version,
  content: JSON.parse(item.content)
}));

// åœ¨æµ‹è¯•çŽ¯å¢ƒå¯¼å…¥é…ç½®
for (const config of configData) {
  const modelDef = config.content;
  await engine.metaRegistry.updateOrRegister(modelDef);
}
```

## å®žé™…åº”ç”¨åœºæ™¯

### å¤šçŽ¯å¢ƒéƒ¨ç½²

åœ¨ CI/CD æµç¨‹ä¸­è‡ªåŠ¨åŒæ­¥é…ç½®ï¼š

```typescript
// deploy-config.js - éƒ¨ç½²è„šæœ¬
import { getEntityEngine } from './lib/entity-engine';
import configData from './config/production-models.json';

const engine = await getEntityEngine();

// éƒ¨ç½²æ—¶æ³¨å†Œæ‰€æœ‰æ¨¡åž‹
for (const modelConfig of configData.models) {
  await engine.metaRegistry.updateOrRegister(modelConfig);
  console.log(`âœ… å·²éƒ¨ç½²æ¨¡åž‹: ${modelConfig.name}`);
}

// æ³¨å†Œè§†å›¾
for (const viewConfig of configData.views) {
  await engine.metaRegistry.updateOrRegisterView(viewConfig);
  console.log(`âœ… å·²éƒ¨ç½²è§†å›¾: ${viewConfig.name}`);
}
```

### é…ç½®å¤‡ä»½

å®šæœŸå¤‡ä»½é…ç½®åˆ°å¤–éƒ¨å­˜å‚¨ï¼š

```typescript
// backup-configs.js - å®šæœŸå¤‡ä»½ä»»åŠ¡
const engine = await getEntityEngine();

// èŽ·å–æ‰€æœ‰é…ç½®
const allConfigs = await engine.datasourceFactory
  .create('__config__')
  .listObjects({
    modelName: '__config__'
  });

// å¤‡ä»½åˆ°äº‘å­˜å‚¨æˆ–æ–‡ä»¶ç³»ç»Ÿ
const backup = {
  timestamp: new Date().toISOString(),
  configs: allConfigs.items,
  totalCount: allConfigs.items.length
};

// ä¿å­˜å¤‡ä»½
await saveToCloudStorage(`backup-${Date.now()}.json`, backup);
```

## æœ€ä½³å®žè·µ

### æ¨¡åž‹å®šä¹‰æ ‡å‡†åŒ–

å»ºç«‹ç»Ÿä¸€çš„æ¨¡åž‹å®šä¹‰è§„èŒƒï¼š

```typescript
// æŽ¨èçš„æ¨¡åž‹å®šä¹‰ç»“æž„
const standardModel = {
  name: 'Product',           // ä½¿ç”¨ PascalCase
  title: 'äº§å“ç®¡ç†',          // æ¸…æ™°çš„ä¸­æ–‡æ ‡é¢˜
  description: 'äº§å“ä¿¡æ¯ç®¡ç†ç³»ç»Ÿ', // è¯¦ç»†æè¿°
  fields: [
    {
      name: 'id',           // æ€»æ˜¯åŒ…å« id å­—æ®µ
      title: 'ID',
      type: 'string',
      isRequired: true
    },
    {
      name: 'createdAt',    // æ ‡å‡†å®¡è®¡å­—æ®µ
      title: 'åˆ›å»ºæ—¶é—´',
      type: 'datetime',
      isRequired: true
    },
    {
      name: 'updatedAt',    // æ ‡å‡†å®¡è®¡å­—æ®µ
      title: 'æ›´æ–°æ—¶é—´', 
      type: 'datetime'
    }
  ]
};
```

### é…ç½®éªŒè¯

æ³¨å†Œå‰éªŒè¯æ¨¡åž‹å®šä¹‰çš„å®Œæ•´æ€§ï¼š

```typescript
// éªŒè¯æ¨¡åž‹å®šä¹‰
const validateModel = (model) => {
  if (!model.name || !model.title) {
    throw new Error('æ¨¡åž‹å¿…é¡»æœ‰ name å’Œ title');
  }
  
  // ç¡®ä¿æœ‰ id å­—æ®µ
  const hasId = model.fields.some(f => f.name === 'id');
  if (!hasId) {
    throw new Error('æ¨¡åž‹å¿…é¡»åŒ…å«id å­—æ®µ');
  }
};

// å®‰å…¨æ³¨å†Œ
try {
  validateModel(newModel);
  await engine.metaRegistry.updateOrRegister(newModel);
} catch (error) {
  console.error('æ¨¡åž‹æ³¨å†Œå¤±è´¥:', error.message);
}
```

### å¼€å‘çŽ¯å¢ƒé…ç½®

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ç›‘æŽ§é…ç½®å˜åŒ–ï¼š

```typescript
// å¼€å‘çŽ¯å¢ƒä¸‹æ˜¾ç¤ºé…ç½®å˜åŒ–
if (process.env.NODE_ENV === 'development') {
  engine.eventRegistry.on('model:registered', (event) => {
    console.log(`ðŸ“ æ¨¡åž‹å·²æ³¨å†Œ: ${event.data.name}`);
    console.log(`   å­—æ®µæ•°é‡: ${event.data.fields.length}`);
  });
  
  engine.eventRegistry.on('view:registered', (event) => {
    console.log(`ðŸŽ¨ è§†å›¾å·²æ³¨å†Œ: ${event.data.name}`);
    console.log(`   ç±»åž‹: ${event.data.type}`);
  });
}
```