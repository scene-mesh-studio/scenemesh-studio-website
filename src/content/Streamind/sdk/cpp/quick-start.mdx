# å¿«é€Ÿå¼€å§‹

5åˆ†é’Ÿå¿«é€Ÿé›†æˆ StreamInd SDK åˆ°ä½ çš„ ESP32-S3 é¡¹ç›®ã€‚

## å‰ç½®è¦æ±‚

å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿ä½ å·²å‡†å¤‡å¥½ï¼š

- âœ… **ESP-IDF 5.0+** - [å®‰è£…æŒ‡å—](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/get-started/)
- âœ… **ESP32-S3 å¼€å‘æ¿** - æ¨è 16MB Flash + 8MB PSRAM
- âœ… **åŸºæœ¬çš„ C++ çŸ¥è¯†** - ç†Ÿæ‚‰ C++17 è¯­æ³•
- âœ… **WiFi ç½‘ç»œ** - ç”¨äºè¿æ¥äº‘å¹³å°
- âœ… **StreamInd å¹³å°è´¦å·** - è·å–ç§Ÿæˆ·IDå’Œäº§å“è®¤è¯ä¿¡æ¯

### è·å–å¹³å°è®¤è¯ä¿¡æ¯

åœ¨ä½¿ç”¨ SDK å‰ï¼Œä½ éœ€è¦ä» StreamInd å¹³å°è·å–ä»¥ä¸‹è®¤è¯ä¿¡æ¯ï¼š

1. **tenant_id**ï¼ˆç§Ÿæˆ·IDï¼‰- ä½ çš„ç»„ç»‡/è´¦æˆ·å”¯ä¸€æ ‡è¯†
2. **product_id**ï¼ˆäº§å“IDï¼‰- è®¾å¤‡æ‰€å±äº§å“çš„æ ‡è¯†
3. **product_key**ï¼ˆäº§å“å¯†é’¥ï¼‰- äº§å“çš„è®¿é—®å¯†é’¥

ç™»å½• StreamInd æ§åˆ¶å°ï¼Œåœ¨ **å¼€å‘é…ç½®èœå•** ä¸­å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†è¿™äº›è®¤è¯ä¿¡æ¯ã€‚

## å®‰è£… SDK

### æ–¹æ³• Aï¼šä½¿ç”¨ Git Submoduleï¼ˆæ¨èï¼‰

```bash
cd your_project
git submodule add https://github.com/streamind/sdk-prebuilt.git components/streamind_sdk
git submodule update --init --recursive
```

### æ–¹æ³• Bï¼šç›´æ¥å¤åˆ¶

1. ä¸‹è½½ [æœ€æ–°ç‰ˆæœ¬](https://github.com/streamind/sdk-prebuilt/releases)
2. è§£å‹åˆ° `your_project/components/streamind_sdk/`

## é…ç½®é¡¹ç›®

### æ­¥éª¤ 1ï¼šç¼–è¾‘ CMakeLists.txt

åœ¨ `main/CMakeLists.txt` ä¸­æ·»åŠ  SDK ä¾èµ–ï¼š

```cmake
idf_component_register(
    SRCS "main.cpp"
    INCLUDE_DIRS "."
    REQUIRES streamind_sdk  # æ·»åŠ StreamInd SDKä¾èµ–
)
```

### æ­¥éª¤ 2ï¼šè®¾ç½®åˆ†åŒºè¡¨ï¼ˆå¯é€‰ï¼‰

å¦‚æœä½ çš„é¡¹ç›®åŠŸèƒ½è¾ƒå¤šï¼Œå»ºè®®ä½¿ç”¨è‡ªå®šä¹‰åˆ†åŒºè¡¨ã€‚åœ¨ `sdkconfig.defaults` ä¸­æ·»åŠ ï¼š

```ini
CONFIG_PARTITION_TABLE_CUSTOM=y
CONFIG_PARTITION_TABLE_CUSTOM_FILENAME="partitions.csv"
```

## åˆå§‹åŒ– SDK

### å®Œæ•´ç¤ºä¾‹ä»£ç 

åˆ›å»º `main/main.cpp`ï¼š

```cpp
#include <streamind.h>
#include <esp_log.h>
#include <esp_wifi.h>
#include <nvs_flash.h>

static const char* TAG = "APP";

// WiFi é…ç½®ï¼ˆè¯·æ›¿æ¢ä¸ºä½ çš„WiFiä¿¡æ¯ï¼‰
#define WIFI_SSID "YOUR_WIFI_SSID"
#define WIFI_PASSWORD "YOUR_WIFI_PASSWORD"

// StreamInd å¹³å°é…ç½®
#define STREAMIND_ENDPOINT "ws://your-platform.com:8090/signals"
#define DEVICE_ID "esp32s3_001"

// å¹³å°è®¤è¯ä¿¡æ¯ï¼ˆä»å¼€å‘é…ç½®èœå•è·å–ï¼‰
#define TENANT_ID "tenant_001"
#define PRODUCT_ID "product_001"
#define PRODUCT_KEY "your_product_key"

// WiFi åˆå§‹åŒ–ï¼ˆç®€åŒ–ç‰ˆï¼‰
void init_wifi() {
    nvs_flash_init();
    esp_netif_init();
    esp_event_loop_create_default();
    esp_netif_create_default_wifi_sta();

    wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT();
    esp_wifi_init(&cfg);

    wifi_config_t wifi_config = {};
    strcpy((char*)wifi_config.sta.ssid, WIFI_SSID);
    strcpy((char*)wifi_config.sta.password, WIFI_PASSWORD);

    esp_wifi_set_mode(WIFI_MODE_STA);
    esp_wifi_set_config(WIFI_IF_STA, &wifi_config);
    esp_wifi_start();
    esp_wifi_connect();

    ESP_LOGI(TAG, "WiFi connecting...");
    vTaskDelay(pdMS_TO_TICKS(5000));  // ç­‰å¾…è¿æ¥
}

extern "C" void app_main(void) {
    // 1ï¸âƒ£ åˆå§‹åŒ–WiFi
    init_wifi();

    // 2ï¸âƒ£ åˆ›å»ºSDKé…ç½®
    streamind::Config config;
    config.device_id = DEVICE_ID;
    config.device_type = "smart_device";
    config.endpoint = STREAMIND_ENDPOINT;

    // ç§Ÿæˆ·å’Œäº§å“è®¤è¯ä¿¡æ¯ï¼ˆå¿…å¡«ï¼‰
    config.tenant_id = TENANT_ID;
    config.product_id = PRODUCT_ID;
    config.product_key = PRODUCT_KEY;

    config.connection_timeout_ms = 10000;
    config.reconnect_interval_ms = 5000;

    // 3ï¸âƒ£ è·å–SDKå®ä¾‹
    auto& sdk = streamind::SDK::GetInstance();

    // 4ï¸âƒ£ åˆå§‹åŒ–SDK
    auto err = sdk.Initialize(config);
    if (err != streamind::Error::OK) {
        ESP_LOGE(TAG, "âŒ SDK initialization failed: %s",
                 sdk.GetLastError().c_str());
        return;
    }
    ESP_LOGI(TAG, "âœ… SDK initialized");

    // 5ï¸âƒ£ æ³¨å†Œç¡¬ä»¶èƒ½åŠ›
    auto& registry = sdk.GetRegistry();

    // æ³¨å†ŒLEDæ§åˆ¶èƒ½åŠ›
    registry.RegisterAction("led.on", [](const auto& directive) {
        ESP_LOGI(TAG, "ğŸ’¡ LED ON command received");
        // TODO: å®ç°LEDæ§åˆ¶
        // gpio_set_level(LED_GPIO, 1);
        return true;
    });

    registry.RegisterAction("led.off", [](const auto& directive) {
        ESP_LOGI(TAG, "ğŸ”´ LED OFF command received");
        // TODO: å®ç°LEDæ§åˆ¶
        // gpio_set_level(LED_GPIO, 0);
        return true;
    });

    ESP_LOGI(TAG, "âœ… Registered %d actions",
             registry.GetStats().action_count);

    // 6ï¸âƒ£ è®¾ç½®è¿æ¥å›è°ƒ
    sdk.SetConnectionCallback([&sdk](bool connected, const std::string& msg) {
        if (connected) {
            ESP_LOGI(TAG, "ğŸŒ Connected to platform");
            // è¿æ¥æˆåŠŸåå¯åŠ¨æŒ‡ä»¤æ¥æ”¶
            sdk.StartDirectiveReceiving();
        } else {
            ESP_LOGW(TAG, "âš ï¸ Disconnected: %s", msg.c_str());
        }
    });

    // 7ï¸âƒ£ è¿æ¥åˆ°å¹³å°
    err = sdk.Connect();
    if (err != streamind::Error::OK) {
        ESP_LOGE(TAG, "âŒ Failed to connect: %s",
                 sdk.GetLastError().c_str());
        return;
    }

    ESP_LOGI(TAG, "ğŸš€ SDK started successfully!");

    // 8ï¸âƒ£ å®šæ—¶å‘é€å¿ƒè·³ä¿¡å·ï¼ˆç¤ºä¾‹ï¼‰
    while (true) {
        vTaskDelay(pdMS_TO_TICKS(30000));  // 30ç§’

        if (sdk.IsConnected()) {
            foundation::Signal heartbeat("device.heartbeat");
            heartbeat.GetPayload()->SetNumber("uptime", esp_timer_get_time() / 1000000);
            heartbeat.GetPayload()->SetNumber("free_heap", esp_get_free_heap_size());
            sdk.SendSignal(heartbeat);

            ESP_LOGI(TAG, "ğŸ’“ Heartbeat sent");
        }
    }
}
```

## ç¼–è¯‘å’Œçƒ§å½•

### è®¾ç½®ç›®æ ‡èŠ¯ç‰‡

```bash
idf.py set-target esp32s3
```

### é…ç½®é¡¹ç›®ï¼ˆå¯é€‰ï¼‰

```bash
idf.py menuconfig
```

æ¨èé…ç½®ï¼š
- **Component config â†’ ESP32S3-Specific** â†’ `Support for external, SPI-connected RAM`
- **Component config â†’ LWIP** â†’ `TCP/IP Task Stack Size` = 8192

### ç¼–è¯‘é¡¹ç›®

```bash
idf.py build
```

### çƒ§å½•å’Œç›‘æ§

```bash
idf.py -p /dev/ttyUSB0 flash monitor
```

ï¼ˆmacOS ç”¨æˆ·é€šå¸¸ä½¿ç”¨ `/dev/tty.usbserial-*` æˆ– `/dev/tty.SLAB_USBtoUART`ï¼‰

## éªŒè¯å®‰è£…

### æœŸæœ›çš„æ—¥å¿—è¾“å‡º

å¯åŠ¨ååº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š

```
I (1234) APP: âœ… SDK initialized
I (1250) APP: âœ… Registered 2 actions
I (3456) APP: ğŸŒ Connected to platform
I (3460) StreamInd: Device registered: esp32s3_001
I (3465) APP: ğŸš€ SDK started successfully!
I (33465) APP: ğŸ’“ Heartbeat sent
```

### æµ‹è¯•æŒ‡ä»¤æ¥æ”¶

åœ¨ä½ çš„å¹³å°æ§åˆ¶å°å‘é€æŒ‡ä»¤ï¼š

```json
{
  "name": "led.on",
  "parameters": "{}"
}
```

åº”è¯¥çœ‹åˆ°æ—¥å¿—ï¼š

```
I (45678) APP: ğŸ’¡ LED ON command received
```

## ä¸‹ä¸€æ­¥

### ğŸ“¤ å‘é€è‡ªå®šä¹‰ä¿¡å·

```cpp
// ä¸ŠæŠ¥æ¸©åº¦ä¼ æ„Ÿå™¨æ•°æ®
foundation::Signal signal("sensor.temperature");
signal.GetPayload()->SetNumber("value", 25.5);
signal.GetPayload()->SetString("unit", "celsius");
signal.GetPayload()->SetNumber("timestamp", esp_timer_get_time() / 1000);
sdk.SendSignal(signal);
```

### ğŸ¤ æ¥æ”¶ TTS éŸ³é¢‘

```cpp
sdk.SetAudioDataCallback([](const uint8_t* data, size_t size) {
    ESP_LOGI(TAG, "ğŸ”Š Received TTS audio: %zu bytes", size);
    // TODO: æ¨é€åˆ°éŸ³é¢‘è§£ç é˜Ÿåˆ—
    // audio_service->PushPacket(data, size);
});
```

### ğŸ“£ å‘é€éŸ³é¢‘æ•°æ®

```cpp
// å‘é€éº¦å…‹é£å½•éŸ³ï¼ˆOPUSæ ¼å¼ï¼‰
uint8_t audio_buffer[1024];
// ... å½•éŸ³å¹¶ç¼–ç ä¸ºOPUS ...
sdk.SendAudioData(audio_buffer, sizeof(audio_buffer), "opus");
```

### ğŸ”§ æ³¨å†Œç¡¬ä»¶é€‚é…å™¨

```cpp
// åˆ›å»ºç¡¬ä»¶é€‚é…å™¨ç±»
class ServoAdapter {
public:
    static std::string GetModuleName() { return "servo"; }

    static void RegisterCapabilities(streamind::CapabilityRegistry& registry) {
        registry.RegisterAction("servo.set_angle", HandleSetAngle);
    }

private:
    static bool HandleSetAngle(const streamind::foundation::Directive& dir) {
        int angle = dir.GetIntParameter("angle", 90);
        // TODO: æ§åˆ¶èˆµæœº
        return true;
    }
};

// åœ¨app_mainä¸­æ³¨å†Œ
streamind::RegisterHardwareAdapter<ServoAdapter>(registry);
```

## æ•…éšœæ’æŸ¥

### è¿æ¥å¤±è´¥

**é—®é¢˜**ï¼šæ— æ³•è¿æ¥åˆ°å¹³å°

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ WiFi æ˜¯å¦å·²è¿æ¥ï¼š`esp_wifi_sta_get_ap_info()`
2. éªŒè¯æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®ï¼ˆåŒ…æ‹¬ç«¯å£å·ï¼‰
3. æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦é˜»æ­¢ WebSocket è¿æ¥
4. å°è¯•å¢åŠ è¿æ¥è¶…æ—¶æ—¶é—´ï¼š`config.connection_timeout_ms = 20000`

### ç¼–è¯‘é”™è¯¯

**é—®é¢˜**ï¼šé“¾æ¥é”™è¯¯ `undefined reference to 'streamind::SDK'`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤ `CMakeLists.txt` ä¸­æ·»åŠ äº† `REQUIRES streamind_sdk`
2. æ¸…ç†æ„å»ºç¼“å­˜ï¼š`rm -rf build && idf.py build`

### å†…å­˜ä¸è¶³

**é—®é¢˜**ï¼šè¿è¡Œæ—¶å´©æºƒ `out of memory`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å¢åŠ ä¸»ä»»åŠ¡æ ˆå¤§å°ï¼š`CONFIG_ESP_MAIN_TASK_STACK_SIZE=24576`
2. å¯ç”¨ PSRAMï¼š`CONFIG_ESP32S3_SPIRAM_SUPPORT=y`
3. ä¼˜åŒ– LWIP ç¼“å†²åŒºå¤§å°

### è°ƒè¯•æ—¥å¿—

å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š

```cpp
esp_log_level_set("StreamInd", ESP_LOG_DEBUG);
esp_log_level_set("WebSocketClient", ESP_LOG_DEBUG);
esp_log_level_set("*", ESP_LOG_INFO);  // å…¶ä»–æ¨¡å—
```

## å®Œæ•´ç¤ºä¾‹

æŸ¥çœ‹ SDK ä»“åº“çš„ `examples/` ç›®å½•è·å–æ›´å¤šç¤ºä¾‹ï¼š

- **éŸ³é¢‘é›†æˆ** - `examples/audio_integration.cpp`
- **å®Œæ•´ TTS** - `examples/audio_tts_complete.cpp`
- **èˆµæœºæ§åˆ¶** - `examples/servo_integration.cpp`
- **ä¼ æ„Ÿå™¨é›†æˆ** - `examples/ultrasonic_integration.cpp`

## è·å–å¸®åŠ©

é‡åˆ°é—®é¢˜ï¼Ÿæˆ‘ä»¬æä¾›å¤šç§æ”¯æŒæ¸ é“ï¼š

- ğŸ“– [å®Œæ•´ API æ–‡æ¡£](./api-reference/sdk-class)
- ğŸ’¬ [GitHub Discussions](https://github.com/streamind/sdk/discussions)
- ğŸ› [é—®é¢˜åé¦ˆ](https://github.com/streamind/sdk/issues)
- ğŸ’¡ [ç¤ºä¾‹ä»£ç ](./examples/audio-integration)

---

**ğŸ‰ æ­å–œï¼ä½ å·²æˆåŠŸé›†æˆ StreamInd SDKï¼**

ç»§ç»­é˜…è¯» [æ ¸å¿ƒæ¦‚å¿µ](./core-concepts) æ·±å…¥äº†è§£ Signal-Directive æ¶æ„ã€‚
